<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumption Analysis - Shelly 3EM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="config-manager.js"></script>
    <script src="device-tracking.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 30%, #0f3460 70%, #1a1a2e 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 600;
            color: white;
        }
        
        .control-group select, .control-group button {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-group button {
            background: rgba(30, 144, 255, 0.7);
            font-weight: 500;
        }
        
        .control-group button:hover {
            background: rgba(30, 144, 255, 0.9);
            transform: translateY(-2px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 15px 0;
            color: #4facfe;
            font-size: 1.2em;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-unit {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 20px;
        }
        
        .chart-card h3 {
            margin: 0 0 20px 0;
            color: #4facfe;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .devices-table {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .devices-table h3 {
            margin: 0;
            padding: 25px;
            color: #4facfe;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: #4facfe;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .device-name {
            font-weight: 600;
        }
        
        .device-type {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }
        
        .consumption-value {
            font-weight: bold;
            color: #00f2fe;
        }
        
        .duration-value {
            color: #ffa726;
        }
        
        .events-count {
            background: rgba(76, 172, 254, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }
        
        .navigation {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .nav-button {
            background: rgba(30, 144, 255, 0.8);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-block;
            margin-left: 10px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .nav-button:hover {
            background: rgba(30, 144, 255, 1);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .phase-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                text-align: center;
            }
        }
        
        /* Phase Analysis Styles */
        .phase-analysis-section {
            margin: 40px 0;
        }
        
        .phase-controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        .phase-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .phase-a {
            border-left: 4px solid #f39c12;
        }
        
        .phase-b {
            border-left: 4px solid #ff6b6b;
        }
        
        .phase-c {
            border-left: 4px solid #4ecdc4;
        }
        
        .phase-devices {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        .phase-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .phase-indicator.phase-a { 
            background: #f39c12; 
            color: white; 
        }
        
        .phase-indicator.phase-b { 
            background: #ff6b6b; 
            color: white; 
        }
        
        .phase-indicator.phase-c { 
            background: #4ecdc4; 
            color: white; 
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="graphs.html" class="nav-button">üìä Dashboard</a>
        <a href="settings.html" class="nav-button">‚öôÔ∏è Settings</a>
    </div>

    <div class="container">
        <div class="header">
            <h1>‚ö° Consumption Analysis</h1>
            <p>Track device usage patterns and energy consumption</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="timeRange">Time Range:</label>
                <select id="timeRange">
                    <option value="1h">Last Hour</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="">All Time</option>
                </select>
            </div>
            <div class="control-group">
                <button onclick="refreshAnalysis()">üîÑ Refresh</button>
                <button onclick="forceRefresh()">üîÑ Force Refresh</button>
                <button onclick="exportData()">üì• Export Data</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Events</h3>
                <div class="stat-value" id="totalEvents">0</div>
                <div class="stat-unit">device activations</div>
            </div>
            <div class="stat-card">
                <h3>Total Consumption</h3>
                <div class="stat-value" id="totalConsumption">0</div>
                <div class="stat-unit">Wh</div>
            </div>
            <div class="stat-card">
                <h3>Active Devices</h3>
                <div class="stat-value" id="activeDevices">0</div>
                <div class="stat-unit">devices used</div>
            </div>
            <div class="stat-card">
                <h3>Average Duration</h3>
                <div class="stat-value" id="averageDuration">0</div>
                <div class="stat-unit">minutes</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h3>üìä Consumption by Device</h3>
                <div class="chart-container">
                    <canvas id="consumptionPieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üìà Events by Device</h3>
                <div class="chart-container">
                    <canvas id="eventsBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Phase Analysis Section -->
        <div class="phase-analysis-section">
            <h3>‚ö° Phase Analysis</h3>
            <div class="phase-controls">
                <div class="control-group">
                    <label for="phaseView">View by Phase:</label>
                    <select id="phaseView" onchange="onPhaseFilterChange()">
                        <option value="all">All Phases</option>
                        <option value="A">Phase A</option>
                        <option value="B">Phase B</option>
                        <option value="C">Phase C</option>
                    </select>
                </div>
            </div>
            
            <div class="phase-stats-grid">
                <div class="stat-card phase-a">
                    <h4>Phase A</h4>
                    <div class="stat-value" id="phaseAConsumption">0</div>
                    <div class="stat-unit">Wh</div>
                    <div class="phase-devices" id="phaseADevices">0 devices</div>
                </div>
                <div class="stat-card phase-b">
                    <h4>Phase B</h4>
                    <div class="stat-value" id="phaseBConsumption">0</div>
                    <div class="stat-unit">Wh</div>
                    <div class="phase-devices" id="phaseBDevices">0 devices</div>
                </div>
                <div class="stat-card phase-c">
                    <h4>Phase C</h4>
                    <div class="stat-value" id="phaseCConsumption">0</div>
                    <div class="stat-unit">Wh</div>
                    <div class="phase-devices" id="phaseCDevices">0 devices</div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>‚ö° Consumption by Phase</h3>
                    <div class="chart-container">
                        <canvas id="phaseConsumptionChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìä Phase Load Distribution</h3>
                    <div class="chart-container">
                        <canvas id="phaseLoadChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Power Consumption Thresholds Analysis Section -->
        <div class="phase-analysis-section">
            <h3>‚ö° Power Consumption Analysis by Thresholds</h3>
            
            <div class="phase-stats-grid">
                <div class="stat-card" style="border-left: 4px solid #28a745;">
                    <h4>Low Consumption</h4>
                    <div class="stat-value" id="lowConsumptionTotal">0</div>
                    <div class="stat-unit">Wh</div>
                    <div class="phase-devices" id="lowConsumptionPercentage">0%</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ffc107;">
                    <h4>Medium Consumption</h4>
                    <div class="stat-value" id="mediumConsumptionTotal">0</div>
                    <div class="stat-unit">Wh</div>
                    <div class="phase-devices" id="mediumConsumptionPercentage">0%</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #dc3545;">
                    <h4>High Consumption</h4>
                    <div class="stat-value" id="highConsumptionTotal">0</div>
                    <div class="stat-unit">Wh</div>
                    <div class="phase-devices" id="highConsumptionPercentage">0%</div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>ü•ß Consumption Distribution by Power Level</h3>
                    <div class="chart-container">
                        <canvas id="thresholdPieChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìä Consumption by Time Periods</h3>
                    <div class="chart-container">
                        <canvas id="timePeriodChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="devices-table">
            <h3>üìã Device Statistics</h3>
            <div class="table-container">
                <table id="devicesTable">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Events</th>
                            <th>Total Consumption</th>
                            <th>Avg Duration</th>
                            <th>Avg Power</th>
                            <th>Phase</th>
                        </tr>
                    </thead>
                    <tbody id="devicesTableBody">
                        <tr>
                            <td colspan="6" class="no-data">Initializing device tracker...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let deviceTracker;
        let consumptionChart;
        let eventsChart;
        let currentAnalysis; // Store current analysis data for phase filter updates
        
        // New charts for threshold analysis
        let thresholdPieChart;
        let timePeriodChart;
        
        // Power thresholds (should match the ones in graphs.html)
        const powerThresholds = {
            low: 300,
            medium: 1000
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Show loading state
                showLoadingState();
                
                deviceTracker = new DeviceTracker();
                
                // Wait for DeviceTracker to fully initialize before loading data
                await waitForDeviceTrackerInitialization();
                
                // Load the analysis data automatically
                refreshAnalysis();
                
                // Add event listener for time range changes
                document.getElementById('timeRange').addEventListener('change', refreshAnalysis);
                
                console.log('Consumption analysis page initialized successfully');
            } catch (error) {
                console.error('Error initializing consumption analysis page:', error);
                showErrorState();
            }
        });

        // Show loading state while initializing
        function showLoadingState() {
            document.getElementById('totalEvents').textContent = '...';
            document.getElementById('totalConsumption').textContent = '...';
            document.getElementById('activeDevices').textContent = '...';
            document.getElementById('averageDuration').textContent = '...';
        }

        // Show error state if initialization fails
        function showErrorState() {
            document.getElementById('totalEvents').textContent = 'Error';
            document.getElementById('totalConsumption').textContent = 'Error';
            document.getElementById('activeDevices').textContent = 'Error';
            document.getElementById('averageDuration').textContent = 'Error';
            
            const tbody = document.getElementById('devicesTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading device data. Please try refreshing the page.</td></tr>';
        }

        // Helper function to wait for DeviceTracker initialization
        async function waitForDeviceTrackerInitialization() {
            // Wait for the configManager to be initialized
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max wait time
            
            while (attempts < maxAttempts) {
                if (deviceTracker.configManager !== null) {
                    // Give it a bit more time to load the data
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Verify that the environment config is loaded
                    const config = deviceTracker.getEnvironmentConfig();
                    if (config && config.devices) {
                        console.log('DeviceTracker fully initialized with', config.devices.length, 'devices');
                        break;
                    }
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (attempts >= maxAttempts) {
                console.warn('DeviceTracker initialization timeout, proceeding anyway');
            }
        }

        function refreshAnalysis() {
            try {
                if (!deviceTracker) {
                    console.warn('DeviceTracker not initialized yet');
                    return;
                }
                
                const timeRange = document.getElementById('timeRange').value;
                const analysis = deviceTracker.getConsumptionAnalysis(timeRange || null);
                
                // Store current analysis for phase filter updates
                currentAnalysis = analysis;
                
                updateStatistics(analysis);
                updateCharts(analysis);
                updateDevicesTable(analysis);
                
                console.log('Analysis refreshed successfully', analysis);
            } catch (error) {
                console.error('Error refreshing analysis:', error);
                showErrorState();
            }
        }

        function forceRefresh() {
            // Clear browser cache and reload the page
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            // Force reload the page
            window.location.reload(true);
        }

        function updateStatistics(analysis) {
            document.getElementById('totalEvents').textContent = analysis.totalEvents;
            document.getElementById('totalConsumption').textContent = analysis.totalConsumption.toFixed(1);
            
            const activeDevices = Object.values(analysis.deviceStats).filter(stats => stats.eventCount > 0).length;
            document.getElementById('activeDevices').textContent = activeDevices;
            
            const totalDuration = Object.values(analysis.deviceStats).reduce((sum, stats) => sum + stats.totalDuration, 0);
            const averageDuration = analysis.totalEvents > 0 ? (totalDuration / analysis.totalEvents) / (1000 * 60) : 0;
            document.getElementById('averageDuration').textContent = averageDuration.toFixed(1);
        }

        function updateCharts(analysis) {
            updateConsumptionPieChart(analysis);
            updateEventsBarChart(analysis);
            updatePhaseAnalysis(analysis);
            // Call threshold analysis asynchronously
            updateThresholdAnalysis(analysis).catch(error => {
                console.error('Error updating threshold analysis:', error);
            });
        }

        function updateConsumptionPieChart(analysis) {
            const ctx = document.getElementById('consumptionPieChart').getContext('2d');
            
            if (consumptionChart) {
                consumptionChart.destroy();
            }

            const deviceStats = Object.values(analysis.deviceStats).filter(stats => stats.totalConsumption > 0);
            
            if (deviceStats.length === 0) {
                // Show "no data" message
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No consumption data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const labels = deviceStats.map(stats => stats.device.name);
            const data = deviceStats.map(stats => stats.totalConsumption);
            const colors = generateColors(deviceStats.length);

            consumptionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(1)} Wh (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateEventsBarChart(analysis) {
            const ctx = document.getElementById('eventsBarChart').getContext('2d');
            
            if (eventsChart) {
                eventsChart.destroy();
            }

            const deviceStats = Object.values(analysis.deviceStats).filter(stats => stats.eventCount > 0);
            
            if (deviceStats.length === 0) {
                // Show "no data" message
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No event data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const labels = deviceStats.map(stats => stats.device.name);
            const data = deviceStats.map(stats => stats.eventCount);

            eventsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Events',
                        data: data,
                        backgroundColor: 'rgba(76, 172, 254, 0.7)',
                        borderColor: 'rgba(76, 172, 254, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white',
                                maxRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateDevicesTable(analysis) {
            const tbody = document.getElementById('devicesTableBody');
            tbody.innerHTML = '';

            const deviceStats = Object.values(analysis.deviceStats);
            
            if (deviceStats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No devices configured. Please configure devices in the settings page.</td></tr>';
                return;
            }

            // Check if there are any devices with events
            const devicesWithEvents = deviceStats.filter(stats => stats.eventCount > 0);
            if (devicesWithEvents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No device activity recorded yet. Devices will appear here once they are used.</td></tr>';
                return;
            }

            // Sort by total consumption (descending)
            deviceStats.sort((a, b) => b.totalConsumption - a.totalConsumption);

            deviceStats.forEach(stats => {
                const row = document.createElement('tr');
                
                const durationMinutes = stats.averageDuration / (1000 * 60);
                const consumptionKwh = stats.totalConsumption / 1000;
                
                row.innerHTML = `
                    <td>
                        <div class="device-name">${stats.device.name}</div>
                        <div class="device-type">${stats.device.type}</div>
                    </td>
                    <td><span class="events-count">${stats.eventCount}</span></td>
                    <td><span class="consumption-value">${consumptionKwh.toFixed(3)} kWh</span></td>
                    <td><span class="duration-value">${durationMinutes.toFixed(1)} min</span></td>
                    <td>${stats.averagePower.toFixed(1)} W</td>
                    <td><span class="phase-indicator phase-${stats.device.phase.toLowerCase()}">Phase ${stats.device.phase}</span></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function generateColors(count) {
            const colors = [
                'rgba(76, 172, 254, 0.8)',
                'rgba(0, 242, 254, 0.8)',
                'rgba(255, 167, 38, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        function exportData() {
            const timeRange = document.getElementById('timeRange').value;
            const analysis = deviceTracker.getConsumptionAnalysis(timeRange || null);
            
            const exportData = {
                timestamp: new Date().toISOString(),
                timeRange: analysis.timeRange,
                summary: {
                    totalEvents: analysis.totalEvents,
                    totalConsumption: analysis.totalConsumption,
                    activeDevices: Object.values(analysis.deviceStats).filter(stats => stats.eventCount > 0).length
                },
                deviceStats: analysis.deviceStats,
                events: analysis.events
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `consumption_analysis_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Phase Analysis Functions
        let phaseConsumptionChart;
        let phaseLoadChart;

        function updatePhaseAnalysis(analysis) {
            const phaseStats = calculatePhaseStatistics(analysis);
            updatePhaseStatistics(phaseStats);
            updatePhaseCharts(phaseStats, analysis);
        }

        function calculatePhaseStatistics(analysis) {
            const phaseStats = {
                A: { consumption: 0, devices: 0, events: 0, deviceList: [] },
                B: { consumption: 0, devices: 0, events: 0, deviceList: [] },
                C: { consumption: 0, devices: 0, events: 0, deviceList: [] }
            };

            Object.values(analysis.deviceStats).forEach(stats => {
                if (stats.device.phase && phaseStats[stats.device.phase]) {
                    const phase = stats.device.phase;
                    phaseStats[phase].consumption += stats.totalConsumption;
                    phaseStats[phase].events += stats.eventCount;
                    if (stats.eventCount > 0) {
                        phaseStats[phase].devices++;
                        phaseStats[phase].deviceList.push(stats.device.name);
                    }
                }
            });

            return phaseStats;
        }

        function updatePhaseStatistics(phaseStats) {
            // Update Phase A
            document.getElementById('phaseAConsumption').textContent = phaseStats.A.consumption.toFixed(1);
            document.getElementById('phaseADevices').textContent = `${phaseStats.A.devices} devices`;

            // Update Phase B
            document.getElementById('phaseBConsumption').textContent = phaseStats.B.consumption.toFixed(1);
            document.getElementById('phaseBDevices').textContent = `${phaseStats.B.devices} devices`;

            // Update Phase C
            document.getElementById('phaseCConsumption').textContent = phaseStats.C.consumption.toFixed(1);
            document.getElementById('phaseCDevices').textContent = `${phaseStats.C.devices} devices`;
        }

        function updatePhaseCharts(phaseStats, analysis) {
            updatePhaseConsumptionChart(phaseStats);
            updatePhaseLoadDistributionChart(phaseStats, analysis);
        }

        function updatePhaseConsumptionChart(phaseStats) {
            const ctx = document.getElementById('phaseConsumptionChart').getContext('2d');
            
            if (phaseConsumptionChart) {
                phaseConsumptionChart.destroy();
            }

            const phases = ['A', 'B', 'C'];
            const data = phases.map(phase => phaseStats[phase].consumption);
            const colors = ['#f39c12', '#ff6b6b', '#4ecdc4'];

            phaseConsumptionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: phases.map(phase => `Phase ${phase}`),
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value.toFixed(1)} Wh (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePhaseLoadDistributionChart(phaseStats, analysis) {
            const ctx = document.getElementById('phaseLoadChart').getContext('2d');
            
            if (phaseLoadChart) {
                phaseLoadChart.destroy();
            }

            const selectedPhase = document.getElementById('phaseView').value;
            console.log('Updating phase load chart for phase:', selectedPhase);
            
            if (selectedPhase === 'all') {
                // Show all phases comparison
                const phases = ['A', 'B', 'C'];
                const consumptionData = phases.map(phase => phaseStats[phase].consumption);
                const eventsData = phases.map(phase => phaseStats[phase].events);

                phaseLoadChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: phases.map(phase => `Phase ${phase}`),
                        datasets: [{
                            label: 'Consumption (Wh)',
                            data: consumptionData,
                            backgroundColor: ['rgba(243, 156, 18, 0.7)', 'rgba(255, 107, 107, 0.7)', 'rgba(78, 205, 196, 0.7)'],
                            borderColor: ['#f39c12', '#ff6b6b', '#4ecdc4'],
                            borderWidth: 2,
                            yAxisID: 'y'
                        }, {
                            label: 'Events',
                            data: eventsData,
                            backgroundColor: 'rgba(76, 172, 254, 0.7)',
                            borderColor: 'rgba(76, 172, 254, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                title: {
                                    display: true,
                                    text: 'Consumption (Wh)',
                                    color: 'white'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                ticks: {
                                    color: 'white',
                                    stepSize: 1
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Events',
                                    color: 'white'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            } else {
                // Show devices for selected phase
                const phaseDevices = Object.values(analysis.deviceStats).filter(stats => 
                    stats.device.phase === selectedPhase && stats.eventCount > 0
                );

                if (phaseDevices.length === 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`No devices found for Phase ${selectedPhase}`, ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                const labels = phaseDevices.map(stats => stats.device.name);
                const data = phaseDevices.map(stats => stats.totalConsumption);
                const phaseColor = selectedPhase === 'A' ? '#f39c12' : selectedPhase === 'B' ? '#ff6b6b' : '#4ecdc4';

                phaseLoadChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Phase ${selectedPhase} Consumption`,
                            data: data,
                            backgroundColor: phaseColor + '70',
                            borderColor: phaseColor,
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                title: {
                                    display: true,
                                    text: 'Consumption (Wh)',
                                    color: 'white'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'white',
                                    maxRotation: 45
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Handler for phase filter changes
        function onPhaseFilterChange() {
            if (currentAnalysis) {
                console.log('Phase filter changed to:', document.getElementById('phaseView').value);
                // Only update phase-related charts, not the main charts
                updatePhaseAnalysis(currentAnalysis);
            } else {
                console.warn('No analysis data available for phase filter update');
            }
        }

        // Threshold Analysis Functions
        async function updateThresholdAnalysis(analysis) {
            try {
                // Fetch consumption events from the generated JSON file with cache-busting
                const response = await fetch(`consumption_events_for_browser.json?t=${Date.now()}`);
                
                if (!response.ok) {
                    console.warn('No consumption events file found, showing empty threshold analysis');
                    showEmptyThresholdAnalysis();
                    return;
                }
                
                const consumptionEvents = await response.json();
                
                if (!Array.isArray(consumptionEvents) || consumptionEvents.length === 0) {
                    console.warn('No consumption events found in file');
                    showEmptyThresholdAnalysis();
                    return;
                }
                
                console.log(`Loaded ${consumptionEvents.length} consumption events from file`);
                
                // Update threshold statistics
                updateThresholdStatistics(consumptionEvents);
                
                // Update threshold charts
                updateThresholdPieChart(consumptionEvents);
                updateTimePeriodChart(consumptionEvents);
                
            } catch (error) {
                console.error('Error loading consumption events:', error);
                showEmptyThresholdAnalysis();
            }
        }
        
        function showEmptyThresholdAnalysis() {
            // Show zero values for all threshold statistics
            document.getElementById('lowConsumptionTotal').textContent = '0';
            document.getElementById('lowConsumptionPercentage').textContent = '0%';
            document.getElementById('mediumConsumptionTotal').textContent = '0';
            document.getElementById('mediumConsumptionPercentage').textContent = '0%';
            document.getElementById('highConsumptionTotal').textContent = '0';
            document.getElementById('highConsumptionPercentage').textContent = '0%';
            
            // Clear charts
            if (thresholdPieChart) {
                thresholdPieChart.destroy();
                thresholdPieChart = null;
            }
            if (timePeriodChart) {
                timePeriodChart.destroy();
                timePeriodChart = null;
            }
        }

        function updateThresholdStatistics(events) {
            // Filter events by time range if specified
            const timeRange = document.getElementById('timeRange').value;
            let filteredEvents = events;
            
            if (timeRange && timeRange !== '') {
                const hoursBack = parseFloat(timeRange.replace('h', '').replace('d', '') * (timeRange.includes('d') ? 24 : 1));
                const cutoffTime = new Date(Date.now() - hoursBack * 60 * 60 * 1000);
                filteredEvents = events.filter(event => 
                    new Date(event.startTime) >= cutoffTime
                );
            }
            
            // Calculate consumption by threshold levels
            const stats = {
                low: { totalEnergy: 0, count: 0 },
                medium: { totalEnergy: 0, count: 0 },
                high: { totalEnergy: 0, count: 0 }
            };
            
            filteredEvents.forEach(event => {
                const energy = parseFloat(event.totalEnergy) || 0;
                
                switch (event.type) {
                    case 'LOW':
                        stats.low.totalEnergy += energy;
                        stats.low.count++;
                        break;
                    case 'MEDIUM':
                        stats.medium.totalEnergy += energy;
                        stats.medium.count++;
                        break;
                    case 'HIGH':
                        stats.high.totalEnergy += energy;
                        stats.high.count++;
                        break;
                }
            });
            
            const totalEnergy = stats.low.totalEnergy + stats.medium.totalEnergy + stats.high.totalEnergy;
            
            // Update UI with calculated statistics
            document.getElementById('lowConsumptionTotal').textContent = stats.low.totalEnergy.toFixed(1);
            document.getElementById('lowConsumptionPercentage').textContent = 
                totalEnergy > 0 ? (stats.low.totalEnergy / totalEnergy * 100).toFixed(1) + '%' : '0%';
                
            document.getElementById('mediumConsumptionTotal').textContent = stats.medium.totalEnergy.toFixed(1);
            document.getElementById('mediumConsumptionPercentage').textContent = 
                totalEnergy > 0 ? (stats.medium.totalEnergy / totalEnergy * 100).toFixed(1) + '%' : '0%';
                
            document.getElementById('highConsumptionTotal').textContent = stats.high.totalEnergy.toFixed(1);
            document.getElementById('highConsumptionPercentage').textContent = 
                totalEnergy > 0 ? (stats.high.totalEnergy / totalEnergy * 100).toFixed(1) + '%' : '0%';
        }

        function updateThresholdPieChart(events) {
            // Filter events by time range
            const timeRange = document.getElementById('timeRange').value;
            let filteredEvents = events;
            
            if (timeRange && timeRange !== '') {
                const hoursBack = parseFloat(timeRange.replace('h', '').replace('d', '') * (timeRange.includes('d') ? 24 : 1));
                const cutoffTime = new Date(Date.now() - hoursBack * 60 * 60 * 1000);
                filteredEvents = events.filter(event => 
                    new Date(event.startTime) >= cutoffTime
                );
            }
            
            // Calculate energy by threshold type
            const energyByType = {
                LOW: 0,
                MEDIUM: 0,
                HIGH: 0
            };
            
            filteredEvents.forEach(event => {
                const energy = parseFloat(event.totalEnergy) || 0;
                energyByType[event.type] += energy;
            });
            
            const ctx = document.getElementById('thresholdPieChart').getContext('2d');
            
            if (thresholdPieChart) {
                thresholdPieChart.destroy();
            }
            
            const totalEnergy = Object.values(energyByType).reduce((sum, val) => sum + val, 0);
            
            if (totalEnergy === 0) {
                // Show "no data" message
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No threshold data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            thresholdPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Low Consumption', 'Medium Consumption', 'High Consumption'],
                    datasets: [{
                        data: [energyByType.LOW, energyByType.MEDIUM, energyByType.HIGH],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',   // Green for low
                            'rgba(255, 193, 7, 0.8)',   // Yellow for medium  
                            'rgba(220, 53, 69, 0.8)'    // Red for high
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = ((value / totalEnergy) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(1)} Wh (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTimePeriodChart(events) {
            // Filter events by time range
            const timeRange = document.getElementById('timeRange').value;
            let filteredEvents = events;
            
            if (timeRange && timeRange !== '') {
                const hoursBack = parseFloat(timeRange.replace('h', '').replace('d', '') * (timeRange.includes('d') ? 24 : 1));
                const cutoffTime = new Date(Date.now() - hoursBack * 60 * 60 * 1000);
                filteredEvents = events.filter(event => 
                    new Date(event.startTime) >= cutoffTime
                );
            }
            
            // Define time periods
            const timePeriods = {
                'Night (00:00-07:00)': { low: 0, medium: 0, high: 0 },
                'Day (07:01-15:00)': { low: 0, medium: 0, high: 0 },
                'Evening (15:01-23:59)': { low: 0, medium: 0, high: 0 }
            };
            
            // Categorize events by time period and consumption type
            filteredEvents.forEach(event => {
                const startTime = new Date(event.startTime);
                const hour = startTime.getHours();
                const energy = parseFloat(event.totalEnergy) || 0;
                
                let period;
                if (hour >= 0 && hour <= 7) {
                    period = 'Night (00:00-07:00)';
                } else if (hour >= 8 && hour <= 15) {
                    period = 'Day (07:01-15:00)';
                } else {
                    period = 'Evening (15:01-23:59)';
                }
                
                switch (event.type) {
                    case 'LOW':
                        timePeriods[period].low += energy;
                        break;
                    case 'MEDIUM':
                        timePeriods[period].medium += energy;
                        break;
                    case 'HIGH':
                        timePeriods[period].high += energy;
                        break;
                }
            });
            
            const ctx = document.getElementById('timePeriodChart').getContext('2d');
            
            if (timePeriodChart) {
                timePeriodChart.destroy();
            }
            
            const labels = Object.keys(timePeriods);
            const lowData = labels.map(label => timePeriods[label].low);
            const mediumData = labels.map(label => timePeriods[label].medium);
            const highData = labels.map(label => timePeriods[label].high);
            
            const totalEnergy = lowData.reduce((sum, val) => sum + val, 0) + 
                              mediumData.reduce((sum, val) => sum + val, 0) + 
                              highData.reduce((sum, val) => sum + val, 0);
            
            if (totalEnergy === 0) {
                // Show "no data" message
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No time period data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            timePeriodChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Low Consumption',
                            data: lowData,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Medium Consumption',
                            data: mediumData,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'High Consumption',
                            data: highData,
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return value.toFixed(1) + ' Wh';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'white',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} Wh`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html> 